<div class="form-row">
  <div class="form-group col-md-6">
    <h5 class="card-title"><i class="bi-{{icon}}" style="font-size: 2rem; margin-right: 8px; vertical-align: bootom; padding-bootom: 0px; color: dimgray;"></i>{{title}} para o chamado: #{{ticket}}</h5>
  </div>
  <div class="form-group col-md-6 d-flex justify-content-end" style="width:100%">
      <a href="{{URL}}/admin/chamados">
        <button type="button" name="button" class="btn btn-sm btn-outline-primary">Voltar</button>
      </a>
  </div>
</div>
{{status}}
<form id="urlAddRequrimentoBt" class="needs-validation" novalidate>
  <div class="modal-body">
    <div class="container">
      <div class="row">
        <div class="col-sm-3" id="delail_data_abertura"></div>
        <div class="col-sm-3" id="delail_statusdoatendimento"></div>
        <div class="col-sm-6" id="delail_descricao"></div>
      </div>
      <div class="row">
        <div class="col-sm-1" id="delail_UsuarioContatoId"></div>
        <div class="col-sm-4" id="delail_UsuarioContatoNome"></div>
        <div class="col-sm-3" id="delail_UsuarioContatoEmail"></div>
        <div class="col-sm-2" id="delail_UsuarioContatoTelefone"></div>
        <div class="col-sm-1" id="delail_UsuarioContatoSiglaDep"></div>
        <div class="col-sm-1" id="delail_UsuarioContatoSala"></div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group col-md-6">
        <label for="recipient-atendimento" class="small-label col-form-label col-md-12 mb-0 p-0">Atendimento: </label>
        <select name="atendimento" required value="" class="form-select form-select-sm" id="recipient-atendimento">
          <option value=''>Selecione o Atendimento</option>
          {{optionsBuscaAtendimento}}
        </select>
        <div class="invalid-feedback">
              Por favor, informe o atendimento desta requisição.
        </div>
        <input type="hidden" name="atendente" value="{{idUsuarioLogado}}" id="recipient-atendente">
        <input type="hidden" name="chamado" value="" id="recipient-chamado">
      </div>
      <div class="form-group col-md-6">
        <label for="recipient-usuario-atendido" class="small-label col-form-label col-md-12 mb-0 p-0">Usuário para o qual se destina o atendimento: </label>
        <select name="usuario-atendido" required value="" class="form-select form-select-sm" id="recipient-usuario-atendido">
          <option value=''>Selecione o Usuário</option>
          {{optionsBuscaUsuario}}
        </select>
        <div class="invalid-feedback">
            Por favor, informe o usuário atendido nesta requisição.
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group col-md-3">
        <label for="recipient-status" class="small-label col-form-label col-md-12 mb-0 p-0">Status: </label>
        <select name="status" required value="" class="form-select form-select-sm" id="recipient-status">
          <option value=''>Selecione o Status</option>
          {{optionsBuscaStatus}}
        </select>
        <div class="invalid-feedback">
              Por favor, selecione o status desta requisição.
        </div>
      </div>
      <div class="form-group col-md-3">
        <label for="recipient-nrdgtec" class="small-label col-form-label col-md-12 mb-0 p-0">Número da DGTEC: </label>
        <input type="text" class="form-control form-control-sm" name="nrdgtec" maxlength="13" value="" id="recipient-nrdgtec" pattern="/(([A-Z]{2})(\d{4}).(\d{6}))/gm">
        <div class="invalid-feedback">
                Por favor, insera um número de chamado DGTEC em formato correto.
          </div>
      </div>
      <div class="form-group col-md-6">
        <label for="recipient-usuario-autorizador" class="small-label col-form-label col-md-12 mb-0 p-0">Usuário Autorizador: (opcional)</label>
        <select name="usuario-autorizador" value="" class="form-select form-select-sm" id="recipient-usuario-autorizador">
          <option value=''>Selecione o Usuário Autorizador</option>
          {{optionsBuscaUsuario}}
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="recipient-urgencia" class="small-label col-form-label col-md-12 mb-0 p-0">Urgência: </label>
        <select name="urgencia" required value="" class="form-select form-select-sm" id="recipient-urgencia">
          <option value=''>Selecione a Urgência</option>
          {{optionsBuscaUrgencia}}
        </select>
        <div class="invalid-feedback">
                Por favor, informe a urgência.
        </div>
      </div>
      <div class="form-group col-md-4">
        <label for="recipient-criticidade" class="small-label col-form-label col-md-12 mb-0 p-0">Criticidade: </label>
        <select name="criticidade" required value="" class="form-select form-select-sm" id="recipient-criticidade">
          <option value=''>Selecione a Criticidade</option>
          {{optionsBuscaCriticidade}}
        </select>
        <div class="invalid-feedback">
                Por favor, informe a criticadade.
              </div>
      </div>
      <div class="form-group col-md-4">
        <label for="recipient-tipodeocorrencia" class="small-label col-form-label col-md-12 mb-0 p-0">Tipo de ocorrência: </label>
        <select name="tipodeocorrencia" required value="" class="form-select form-select-sm" id="recipient-tipodeocorrencia">
          <option value=''>Selecione o Tipo de ocorrência</option>
          {{optionsBuscaTipodeOcorrencia}}
        </select>
        <div class="invalid-feedback">
                Por favor, informe o tipo de ocorrência.
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-12">
        <label for="recipient-desc" class="small-label col-form-label col-md-12 mb-0 p-0">Observação: </label>
        <textarea class="form-control" name="descricao" value="" rows="3" maxlength="5000" id="recipient-desc"></textarea>
      </div>
    </div>
<div class="modal-footer col-mb-12">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
  <button type="submit" class="btn btn-primary" id="add-button" name="button">Cadastrar Requisição</button>
</div>
</div>
</form>
<script type="text/javascript" src="{{URL}}/resources/js/custom.js"></script>
<script type="text/javascript">

  $(document).ready(function() {
      $('#recipient-atendimento').select2();
      $('#recipient-usuario-atendido').select2();
      $('#recipient-usuario-autorizador').select2();
  });

  $("#recipient-nrdgtec").mask("SS0000.000000");

  (function () {
  'use strict'

  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')

  // Loop over them and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })
  })()


  $('#action-btn-b').click(function(e){
     if($('#action-btn-b').is(':checked')){
          console.log("on");
          $('#container-b').removeClass('hide');
     } else {
         console.log("off");
         $('#container-b').addClass('hide');
         zeraUsuarioAtendimento();
         validaUsuario();
     }
  })

  function zeraUsuarioContato(){
    zeraUsuarioAtendimento();
    $('#nome_contato').val(null);
    $('#emailcontato').val(null);
    $('#departamento_contato_id').val(null);
    $('#departamento_contato').val(null);
    $('#sala_contato_id').val(null);
    $('#sala_contato').val(null);
    $('#ramal_contato').val(null);
    validaUsuario();
  }
  function zeraUsuarioAtendimento(){
    //document.getElementById("action-btn-b").classList.toggle("hide");
    $('idatendimento option:eq(1)');
    $('#idatendimento option:eq(1)').prop('selected', true);
    $('#idatendimento').val('25');
    $('#nome_atendimento').val(null);
    $('#emailatendimento').val(null);
    $('#departamento_atendimento_id').val(null);
    $('#departamento_atendimento').val(null);
    $('#sala_atendimento_id').val(null);
    $('#sala_atendimento').val(null);
    $('#ramal_atendimento').val(null);
    $('#idatendimento').select2();
  }

  $(document).ready(function() {
      $('#idcontato').select2();
      $('#idatendimento').select2();
  });

  function validaUsuario(){
    if($('#departamento_atendimento_id').val()){
      $('#recipient-sala-item-checado').val($('#sala_atendimento_id').val());
      $('#recipient-departamento-item-checado').val($('#departamento_atendimento_id').val());
      console.log('USUÁRIO DE ATENDIMENTO = '+$('#departamento_atendimento_id').val());
    } else {
      if($('#departamento_contato_id').val()){
        $('#recipient-sala-item-checado').val($('#sala_contato_id').val());
        $('#recipient-departamento-item-checado').val($('#departamento_contato_id').val());
        console.log('USUÁRIO DE CONTANTO = '+$('#departamento_contato_id').val());
      } else {
        $('#recipient-sala-item-checado').val($('#sala_usuario_logado_id').val());
        $('#recipient-departamento-item-checado').val($('#departamento_usuario_logado_id').val());
        console.log('APENAS USUÁRIO DE LOGADO = '+$('#sala_usuario_logado_id').val());
      }
    }
    listaICs();
  }

  $(function(){
    $(".categoriadeic").click(function () {
      id = $("input[type=radio][name='categoriadeic']:checked").val();
      if( $(this).val() ) {
        $('#tipodeic').hide();
        $('#servico').hide();
        $('#label-servico').hide();
        $('#itemdeconfiguracao').hide();
        $('#label-itemdeconfiguracao').hide();
        $('#recipient-chamado_nm').val('');
        $('#recipient-itens_checados').val('');
        $('.carregando').show();
          $.getJSON('jsoncategoria?',{categoriadeic: $(this).val(), ajax: 'true'}, function(j){
						var options = '<option value="">Selecione o tipo de item</option>';
						for (var i = 0; i < j.length; i++) {
							options += '<option value="' + j[i].id + '">' + j[i].tipodeic_nm + '</option>';
						}
						$('#tipodeic').html(options).show();
						$('.carregando').hide();
					});
      } else {
        $('#tipodeic').html('<option value="">Selecione o tipo de item</option>');
      }
    });
    // JSON PARA RETORNAR DADOS (Nome,Departamento[SIGLA;ID],Localização[NOME;ID]) DO USUÁRIO POR E-MAIL
    $("#idcontato").change(function() {
      if( $(this).val() ) {
          $.getJSON('jsonusuarioporid?',{id: $(this).val(), ajax: 'true'}, function(j){
            //console.log('nome_contato = '+j[0].nome_contato);
            $('#nome_contato').val(j[0].nome_contato);
            $('#emailcontato').val(j[0].email_contato);
            $('#departamento_contato_id').val(j[0].departamento_id);
            $('#departamento_contato').val(j[0].departamento_sg);
            $('#sala_contato_id').val(j[0].localizacao_id);
            $('#sala_contato').val(j[0].localizacao_nm);
            $('#ramal_contato').val(j[0].usuario_fone);
            $('#recipient-sala-item-checado').val(j[0].localizacao_id);
            $('#recipient-departamento-item-checado').val(j[0].departamento_id);
            validaUsuario();
				});
      } else {
        zeraUsuarioContato();
      }

    });
    // JSON PARA RETORNAR DADOS (Nome,Departamento[SIGLA;ID],Localização[NOME;ID]) DO USUÁRIO POR E-MAIL
    $("#idatendimento").change(function() {
      if( $(this).val() ) {

          $.getJSON('jsonusuarioporid?',{id: $(this).val(), ajax: 'true'}, function(j){
            //console.log('nome_contato = '+j[0].nome_contato);
            $('#nome_atendimento').val(j[0].nome_contato);
            $('#emailatendimento').val(j[0].email_contato);
            $('#departamento_atendimento_id').val(j[0].departamento_id);
            $('#departamento_atendimento').val(j[0].departamento_sg);
            $('#sala_atendimento_id').val(j[0].localizacao_id);
            $('#sala_atendimento').val(j[0].localizacao_nm);
            $('#ramal_atendimento').val(j[0].usuario_fone);
            $('#recipient-sala-item-checado').val(j[0].localizacao_id);
            $('#recipient-departamento-item-checado').val(j[0].departamento_id);
            validaUsuario();
        });
      } else {
        zeraUsuarioAtendimento();
      }

    });
    $("#tipodeic").change(function() {
      if( $(this).val() ) {
        $('#servico').hide();
        $('#label-servico').hide();
        $('#itemdeconfiguracao').hide();
        $('#label-itemdeconfiguracao').hide();
        $('#recipient-chamado_nm').val('');
        $('#recipient-itens_checados').val('');
        $('.carregando').show();
            $.getJSON('jsonservico?',{tipodeic: $(this).val(), ajax: 'true'}, function(j){
						var options = '<option value="">Selecione o serviço</option>';
						for (var i = 0; i < j.length; i++) {
							options += '<option value="' + j[i].id + '">' + j[i].servico_nm + '</option>';
						}
						$('#servico').html(options).show();
            $('.carregando').hide();
            $('#label-servico').show();
					});
      } else {
        $('#servico').hide();
        $('#label-servico').hide();
        $('#itemdeconfiguracao').hide();
        $('#label-itemdeconfiguracao').hide();
      }
    });

    $("#servico").change(function() {
      if( $(this).val() ) {
        $('#itemdeconfiguracao').hide();
        $('#label-itemdeconfiguracao').hide();
        $('.carregando').show();
            listaICs();

            } else {
              $('#itemdeconfiguracao').hide();
              $('#label-itemdeconfiguracao').hide();
            }
          });
      });

  $(document).ready(function() {
        $("#itemdeconfiguracao").click(function(e) {
            var checados = [];
            $.each($("input[name='optionsIC[]']:checked"), function(){
                checados.push($(this).parent().text());
            });
            $('#recipient-itens_checados').val(checados.join(", "));
        });
    });

    function listaICs() {
      var sala = $('#recipient-sala-item-checado').val();
      var tipo = $('#tipodeic').val();
      var serv = $("#servico").val();
      var depart = $('#recipient-departamento-item-checado').val();

      if(sala && tipo && serv)  {
          console.log('dep = '+depart+' sala = '+sala+' tipo = '+tipo+' serv = '+serv);
          //$('#departamento').val() RETIRADO E VALOR 5 (DETEC) FORÇADO PARA TESTES
          $.getJSON('jsonics?',{servico: serv, tipodeic: tipo, departatendido: depart, departamento: 5, sala: sala, ajax: 'true'}, function(j){
          var options = '';
          for (var i = 0; i < j.length; i++) {
            options += '<label class="btn btn-sm btn-outline-primary" for="option' + j[i].id + '" tabindex="0" role="button" data-bs-toggle="popover" title="' + j[i].descricao + '"  data-bs-placement="bottom" data-bs-trigger="hover" data-bs-content="' + j[i].descricao + '"><input type="checkbox" value="' + j[i].id + '" name="optionsIC[]" id="option' + j[i].id + '" class="btn-check" autocomplete="off" />' + j[i].itemdeconf_nm + '</label>&nbsp';
          }
          $('#itemdeconfiguracao').html(options).show();
          $('.carregando').hide();
          $('#label-itemdeconfiguracao').show();
          $('#recipient-chamado_nm').val('Solicitação para '+$('#servico :selected').text()+': '+$('#tipodeic :selected').text());
          });
      }
    }

  function show2(ev2) {

    var rowescolha = document.querySelector('.escolha');
    var srt = '';

    if (ev2 == 'categoriadeic3') {
      rowescolha.style.display = "none";
    } else {
      rowescolha.style.display = "block";
      if (ev2 == 'categoriadeic2') {
        srt = 'sistema/aplicativo';
      }
      if (ev2 == 'categoriadeic1') {
        srt = 'equipamento';
      }
      document.getElementById('label-tipodeic').textContent = 'Selecione o '+srt+':';

    }
  }


  validaUsuario();

</script>
